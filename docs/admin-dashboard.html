<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RiskXLabs Box – Admin Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="box-body">
  <div class="box-shell">
    <!-- Top Nav -->
    <header class="box-topbar">
      <a href="index.html" class="box-pill-link">
        &larr; Home
      </a>
    </header>

    <!-- Masthead -->
    <section class="box-masthead">
      <div class="box-logo-orbit">
        <div class="box-logo-disc">X</div>
      </div>
      <div class="box-masthead-text">
        <div class="box-masthead-label">RISKXLABS</div>
        <h1 class="box-masthead-title">Box Console</h1>
        <p class="box-masthead-subtitle">
          Generate Box Codes, track your Boxes, and retrieve crypto addresses.
        </p>
      </div>
    </section>

    <main class="box-main">
      <!-- Top strip: My Boxes + Actions -->
      <section class="box-card box-card-strip">
        <div class="box-strip-left">
          <div class="box-strip-title">My Boxes</div>
          <div class="box-strip-subtitle">
            Signed in as <span id="admin-email" class="box-chip-muted">Loading…</span>
          </div>
        </div>
        <div class="box-strip-right">
          <button id="generate-btn" class="box-btn box-btn-cta">
            Generate New Box Code
          </button>
          <button id="logout-btn" class="box-btn box-btn-outline">
            Logout
          </button>
        </div>
      </section>

      <!-- Lookup Card -->
      <section class="box-card box-card-primary">
        <header class="box-card-header">
          <h2 class="box-card-title">Lookup Any Box Code</h2>
          <p class="box-card-subtitle">
            Search for the status and contents of any Box Code, regardless of who created it.
          </p>
        </header>

        <form id="lookup-form" class="box-form-inline">
          <div class="box-field-inline">
            <label class="box-label" for="lookup-code">Box Code</label>
            <input
              id="lookup-code"
              type="text"
              class="box-input"
              maxlength="7"
              placeholder="E.g. Q594210"
              required
            />
          </div>
          <button type="submit" class="box-btn box-btn-secondary">
            Search
          </button>
        </form>

        <div id="lookup-result" class="box-lookup-result"></div>
      </section>

      <!-- Active Boxes -->
      <section class="box-card">
        <header class="box-card-header-row">
          <div>
            <h2 class="box-card-title-sm">Active Boxes (Created by You)</h2>
            <p class="box-card-subtitle-sm">
              Codes that have not yet expired and are still in use.
            </p>
          </div>
          <div class="box-card-chip-group">
            <span id="active-count" class="box-chip-pill">0 active</span>
          </div>
        </header>
        <div id="active-boxes" class="box-table-container">
          <div class="box-table-empty">No active Boxes created by you.</div>
        </div>
      </section>

      <!-- Recent / Expired Boxes -->
      <section class="box-card">
        <header class="box-card-header-row">
          <div>
            <h2 class="box-card-title-sm">
              Expired / Consumed (Last 12 Hours, Created by You)
            </h2>
          </div>
          <div class="box-card-chip-group">
            <span id="recent-count" class="box-chip-pill">0</span>
          </div>
        </header>
        <div id="recent-boxes" class="box-table-container">
          <div class="box-table-empty">No Boxes in the last 12 hours.</div>
        </div>
      </section>

      <footer class="box-footer">
        &copy; 2025 RiskXLabs &middot; We Fight Fraud
      </footer>
    </main>
  </div>

  <script>
    const API_BASE = "https://riskxlabs-box-cloudflare-v2.agedotcom.workers.dev";

    document.addEventListener("DOMContentLoaded", () => {
      const emailChip = document.getElementById("admin-email");
      const logoutBtn = document.getElementById("logout-btn");
      const generateBtn = document.getElementById("generate-btn");
      const activeContainer = document.getElementById("active-boxes");
      const recentContainer = document.getElementById("recent-boxes");
      const activeCount = document.getElementById("active-count");
      const recentCount = document.getElementById("recent-count");
      const lookupForm = document.getElementById("lookup-form");
      const lookupCodeInput = document.getElementById("lookup-code");
      const lookupResult = document.getElementById("lookup-result");

      async function fetchJson(path, options = {}) {
        const res = await fetch(`${API_BASE}${path}`, {
          credentials: "include",
          ...options
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.message || "Request failed.");
        }
        return data;
      }

      function formatDateTime(iso) {
        if (!iso) return "—";
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return iso;
        return dt.toLocaleString();
      }

      function renderTables(container, boxes, isActiveSection) {
        if (!boxes || boxes.length === 0) {
          container.innerHTML = '<div class="box-table-empty">No records.</div>';
          return;
        }

        const header = `
          <div class="box-table-row box-table-head">
            <div>Code</div>
            <div>Status</div>
            <div>Created</div>
            <div>Expires</div>
            <div>Submitted</div>
            <div>Retrieved</div>
          </div>
        `;

        const rows = boxes
          .map((b) => {
            const unread = isActiveSection && b.status === "address_submitted";
            const rowClass = unread ? "box-table-row box-row-unread" : "box-table-row";
            return `
              <div class="${rowClass}">
                <div><span class="box-code-pill">${b.code}</span></div>
                <div><span class="box-status-pill box-status-${b.status}">
                  ${b.status.replace(/_/g, " ")}
                </span></div>
                <div>${formatDateTime(b.created_at)}</div>
                <div>${formatDateTime(b.expires_at)}</div>
                <div>${formatDateTime(b.submitted_at)}</div>
                <div>${formatDateTime(b.retrieved_at)}</div>
              </div>
            `;
          })
          .join("");

        container.innerHTML = header + rows;
      }

      async function loadMe() {
        try {
          const data = await fetchJson("/api/admin/me");
          emailChip.textContent = data.admin?.email || "Unknown admin";
          emailChip.classList.remove("box-chip-muted");
          emailChip.classList.add("box-chip");
        } catch (err) {
          console.error("Not authenticated", err);
          window.location.href = "admin-login.html";
        }
      }

      async function loadLists() {
        try {
          const active = await fetchJson("/api/admin/my-codes?scope=active");
          const recent = await fetchJson("/api/admin/my-codes?scope=recent");

          activeCount.textContent = `${active.boxes?.length ?? 0} active`;
          recentCount.textContent = `${recent.boxes?.length ?? 0}`;

          renderTables(activeContainer, active.boxes, true);
          renderTables(recentContainer, recent.boxes, false);
        } catch (err) {
          console.error("Error loading lists", err);
        }
      }

      generateBtn.addEventListener("click", async () => {
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating…";
        try {
          await fetchJson("/api/admin/create-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          await loadLists();
        } catch (err) {
          alert(err.message || "Failed to generate Box Code.");
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate New Box Code";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await fetchJson("/api/admin/logout", { method: "POST" });
        } catch (err) {
          console.error("Logout error", err);
        } finally {
          window.location.href = "admin-login.html";
        }
      });

      lookupForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        lookupResult.innerHTML = "";

        const code = lookupCodeInput.value.trim().toUpperCase();
        if (!code) return;

        try {
          const data = await fetchJson("/api/admin/lookup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code })
          });

          const box = data.box;
          if (!box) {
            lookupResult.innerHTML =
              '<div class="box-table-empty">No Box found for that code.</div>';
            return;
          }

          const masked = box.crypto_address
            ? box.crypto_address.replace(/^(.{6}).+(.{4})$/, "$1…$2")
            : "Not submitted yet.";

          lookupResult.innerHTML = `
            <div class="box-lookup-card">
              <div class="box-lookup-header">
                <span class="box-code-pill">${box.code}</span>
                <span class="box-status-pill box-status-${box.status}">
                  ${box.status.replace(/_/g, " ")}
                </span>
              </div>
              <div class="box-lookup-body">
                <div><strong>Created:</strong> ${formatDateTime(box.created_at)}</div>
                <div><strong>Expires:</strong> ${formatDateTime(box.expires_at)}</div>
                <div><strong>Submitted:</strong> ${formatDateTime(box.submitted_at)}</div>
                <div><strong>Retrieved:</strong> ${formatDateTime(box.retrieved_at)}</div>
                <div class="box-mt-sm">
                  <strong>Masked Crypto Address:</strong>
                  <code>${masked}</code>
                </div>
              </div>
              <div class="box-lookup-footer">
                <button
                  id="retrieve-btn"
                  class="box-btn box-btn-danger"
                  ${box.status !== "address_submitted" ? "disabled" : ""}>
                  Retrieve Full Address
                </button>
              </div>
            </div>
          `;

          const retrieveBtn = document.getElementById("retrieve-btn");
          if (retrieveBtn && box.status === "address_submitted") {
            retrieveBtn.addEventListener("click", async () => {
              retrieveBtn.disabled = true;
              retrieveBtn.textContent = "Retrieving…";
              try {
                const res = await fetchJson("/api/admin/retrieve", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ code })
                });
                const full = res.crypto_address || "";
                lookupResult.querySelector(".box-lookup-body").innerHTML += `
                  <div class="box-mt-sm">
                    <strong>Full Crypto Address:</strong>
                    <code>${full}</code>
                  </div>
                `;
                await loadLists();
              } catch (err) {
                alert(err.message || "Failed to retrieve address.");
              } finally {
                retrieveBtn.disabled = false;
                retrieveBtn.textContent = "Retrieve Full Address";
              }
            });
          }
        } catch (err) {
          lookupResult.innerHTML =
            `<div class="box-alert box-alert-error">${err.message}</div>`;
        }
      });

      // Initial load
      loadMe().then(loadLists);
    });
  </script>
</body>
</html>
