<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RiskXLabs Box – Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="rx-page">

  <div class="rx-shell">
    <header class="rx-header">
      <div class="rx-logo-mark">RX</div>
      <div class="rx-header-text">
        <h1>RiskXLabs Box</h1>
        <p>Admin Dashboard</p>
      </div>
      <div class="rx-header-meta">
        <span id="admin-email" class="rx-pill rx-pill-muted">Loading…</span>
        <button id="logout-btn" class="rx-btn rx-btn-outline">Logout</button>
      </div>
    </header>

    <main class="rx-main">
      <!-- CREATE CODE -->
      <section class="rx-card rx-card-split">
        <div>
          <h2>Generate New Box Code</h2>
          <p class="rx-muted">
            Create a one-time 7-character Box Code that expires after 15 minutes.
          </p>
          <button id="generate-btn" class="rx-btn rx-btn-primary">
            Generate Box Code
          </button>
        </div>
        <div class="rx-code-display">
          <span class="rx-label-small">Latest Generated Code</span>
          <div id="latest-code" class="rx-code-value">–</div>
          <div id="latest-expiry" class="rx-muted rx-text-small"></div>
        </div>
      </section>

      <!-- ACTIVE BOXES -->
      <section class="rx-card">
        <div class="rx-card-header">
          <h2>Active Boxes</h2>
          <span class="rx-badge" id="active-count">0</span>
        </div>
        <div id="active-boxes" class="rx-table-container">
          <div class="rx-table-empty">No active Box Codes yet.</div>
        </div>
      </section>

      <!-- RECENT / EXPIRED BOXES -->
      <section class="rx-card">
        <div class="rx-card-header">
          <h2>Expired / Consumed (Last 12 Hours)</h2>
          <span class="rx-badge" id="recent-count">0</span>
        </div>
        <div id="recent-boxes" class="rx-table-container">
          <div class="rx-table-empty">No recent Box Codes.</div>
        </div>
      </section>

      <!-- LOOKUP -->
      <section class="rx-card">
        <h2>Lookup / Retrieve</h2>
        <p class="rx-muted">
          Search for any Box Code. You may retrieve the full crypto address if needed.
        </p>

        <form id="lookup-form" class="rx-form-inline">
          <label class="rx-label-inline">
            Box Code
            <input id="lookup-code" class="rx-input" maxlength="7" required />
          </label>
          <button type="submit" class="rx-btn rx-btn-secondary">
            Search
          </button>
        </form>

        <div id="lookup-result" class="rx-lookup-result"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "https://riskxlabs-box-cloudflare-v2.agedotcom.workers.dev";

    document.addEventListener("DOMContentLoaded", () => {
      const emailChip = document.getElementById("admin-email");
      const logoutBtn = document.getElementById("logout-btn");
      const generateBtn = document.getElementById("generate-btn");
      const latestCodeEl = document.getElementById("latest-code");
      const latestExpiryEl = document.getElementById("latest-expiry");
      const activeContainer = document.getElementById("active-boxes");
      const recentContainer = document.getElementById("recent-boxes");
      const activeCount = document.getElementById("active-count");
      const recentCount = document.getElementById("recent-count");
      const lookupForm = document.getElementById("lookup-form");
      const lookupCodeInput = document.getElementById("lookup-code");
      const lookupResult = document.getElementById("lookup-result");

      async function fetchJson(path, options = {}) {
        const res = await fetch(`${API_BASE}${path}`, {
          credentials: "include",
          ...options
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          const msg = data.message || "Request failed.";
          throw new Error(msg);
        }
        return data;
      }

      function formatDateTime(iso) {
        if (!iso) return "—";
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return iso;
        return dt.toLocaleString();
      }

      function renderBoxes(container, boxes, highlightUnread) {
        if (!boxes || boxes.length === 0) {
          container.innerHTML = '<div class="rx-table-empty">No records.</div>';
          return;
        }
        const rows = boxes.map(box => {
          const statusLabel = box.status || "unknown";
          const unread = highlightUnread && statusLabel === "address_submitted";
          const cls = unread ? "rx-row-unread" : "";
          return `
            <div class="rx-row ${cls}">
              <div class="rx-cell rx-cell-code">
                <span class="rx-code-chip">${box.code}</span>
                <span class="rx-status-pill rx-status-${statusLabel}">
                  ${statusLabel.replace(/_/g, " ")}
                </span>
              </div>
              <div class="rx-cell">
                <span class="rx-label-small">Created</span>
                <div>${formatDateTime(box.created_at)}</div>
              </div>
              <div class="rx-cell">
                <span class="rx-label-small">Expires</span>
                <div>${formatDateTime(box.expires_at)}</div>
              </div>
              <div class="rx-cell">
                <span class="rx-label-small">Submitted</span>
                <div>${formatDateTime(box.submitted_at)}</div>
              </div>
              <div class="rx-cell">
                <span class="rx-label-small">Retrieved</span>
                <div>${formatDateTime(box.retrieved_at)}</div>
              </div>
            </div>
          `;
        }).join("");

        container.innerHTML = `<div class="rx-table">${rows}</div>`;
      }

      async function loadMe() {
        try {
          const data = await fetchJson("/api/admin/me");
          emailChip.textContent = data.admin?.email || "Unknown admin";
          emailChip.classList.remove("rx-pill-muted");
          emailChip.classList.add("rx-pill");
        } catch (err) {
          console.error(err);
          // If not authenticated from GitHub Pages, bounce to login
          window.location.href = "admin-login.html";
        }
      }

      async function loadLists() {
        try {
          const active = await fetchJson("/api/admin/my-codes?scope=active");
          const recent = await fetchJson("/api/admin/my-codes?scope=recent");
          activeCount.textContent = active.boxes?.length ?? 0;
          recentCount.textContent = recent.boxes?.length ?? 0;
          renderBoxes(activeContainer, active.boxes, true);
          renderBoxes(recentContainer, recent.boxes, false);
        } catch (err) {
          console.error("Error loading lists", err);
        }
      }

      generateBtn.addEventListener("click", async () => {
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";
        try {
          const data = await fetchJson("/api/admin/create-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          latestCodeEl.textContent = data.code || "—";
          latestExpiryEl.textContent = data.box
            ? `Expires: ${formatDateTime(data.box.expires_at)}`
            : "";
          await loadLists();
        } catch (err) {
          alert(err.message || "Failed to generate Box Code.");
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate Box Code";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await fetchJson("/api/admin/logout", { method: "POST" });
        } catch (err) {
          console.error("Logout error", err);
        } finally {
          window.location.href = "admin-login.html";
        }
      });

      lookupForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        lookupResult.innerHTML = "";
        const code = lookupCodeInput.value.trim().toUpperCase();
        if (!code) return;

        try {
          const data = await fetchJson("/api/admin/lookup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code })
          });

          const box = data.box;
          if (!box) {
            lookupResult.innerHTML =
              '<div class="rx-table-empty">No Box found for that code.</div>';
            return;
          }

          const masked = box.crypto_address
            ? box.crypto_address.replace(/^(.{6}).+(.{4})$/, "$1…$2")
            : "Not submitted yet.";

          lookupResult.innerHTML = `
            <div class="rx-lookup-card">
              <div class="rx-lookup-header">
                <span class="rx-code-chip">${box.code}</span>
                <span class="rx-status-pill rx-status-${box.status}">
                  ${box.status.replace(/_/g, " ")}
                </span>
              </div>
              <div class="rx-lookup-body">
                <div><strong>Created:</strong> ${formatDateTime(box.created_at)}</div>
                <div><strong>Expires:</strong> ${formatDateTime(box.expires_at)}</div>
                <div><strong>Submitted:</strong> ${formatDateTime(box.submitted_at)}</div>
                <div><strong>Retrieved:</strong> ${formatDateTime(box.retrieved_at)}</div>
                <div class="rx-mt-sm">
                  <strong>Masked Crypto Address:</strong>
                  <code>${masked}</code>
                </div>
              </div>
              <div class="rx-lookup-footer">
                <button id="retrieve-btn" class="rx-btn rx-btn-danger"
                  ${box.status !== "address_submitted" ? "disabled" : ""}>
                  Retrieve Full Address
                </button>
              </div>
            </div>
          `;

          const retrieveBtn = document.getElementById("retrieve-btn");
          if (retrieveBtn && box.status === "address_submitted") {
            retrieveBtn.addEventListener("click", async () => {
              retrieveBtn.disabled = true;
              retrieveBtn.textContent = "Retrieving...";
              try {
                const res = await fetchJson("/api/admin/retrieve", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ code })
                });
                const full = res.crypto_address || "";
                lookupResult.querySelector(".rx-lookup-body").innerHTML += `
                  <div class="rx-mt-sm">
                    <strong>Full Crypto Address:</strong>
                    <code>${full}</code>
                  </div>
                `;
                await loadLists();
              } catch (err) {
                alert(err.message || "Failed to retrieve address.");
              } finally {
                retrieveBtn.disabled = false;
                retrieveBtn.textContent = "Retrieve Full Address";
              }
            });
          }
        } catch (err) {
          lookupResult.innerHTML =
            `<div class="rx-alert rx-alert-error">${err.message}</div>`;
        }
      });

      // Initial load
      loadMe().then(loadLists);
    });
  </script>
</body>
</html>
